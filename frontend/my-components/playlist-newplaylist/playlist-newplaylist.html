<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">

<dom-module id="playlist-newplaylist">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
    <div id="uploadForm">
      <paper-input id="title" label="Tittel" value="{{title}}"></paper-input>
      <paper-input id="description" label="Beskrivelse" value="{{description}}"></paper-input>
      <label for="thumbnail">Thumbnail: </label> <input type="file" name="thumbnail" id="thumbnail"><br />
      
      <canvas id="cv" height="400" width="400"></canvas><br>
      <paper-button raised on-click="getThumbnail">Velg thumbnail</paper-button>
      <paper-button raised on-click="upload">Legg til spilleliste</paper-button>

      
      
      <paper-dialog id="setThumbnailDialog">
        <h2>Sett et bilde som thumbnail</h2>
        <p>Velg et bilde fra videoen som thumbnail.<br /><br />
          Spill/Spol igjennom videoen til du er der du vil ha thumbnail, og klikk på knappen "Sett som thumbnail".
        </p>
        <video id="player" controls></video>
        <div class="buttons">
          <paper-button autofocus dialog-confirm on-click="setThumbnail">Sett som thumbnail</paper-button>
        </div>
      </paper-dialog>
      <paper-dialog id="resultDialog">
          <h2>[[responseStatus]].</h2>
          <p>[[responseMessage]]</p>
          <div class="buttons">
            <paper-button autofocus dialog-confirm>OK</paper-button>
          </div>
      </paper-dialog>
    </div>
  </template>

  <script>
    /**
     * `playlist-newplaylist`
     * Element to make a new playlist
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class PlaylistNewplaylist extends Polymer.Element {
      static get is() { return 'playlist-newplaylist'; }
      static get properties() {
        return {
          playlistURL : {
            type: String,
            value: window.Polymer.apiBaseURL+'/playlist/add.php'
          },
          title: String,
          description: String,
          thumbnail: String,
          responseMessage: String,
          responseStatus: {
            type: String,
            value: ''
          }
        };
      }
      /*
      * Upload newly made playlist to server
      *
      */
      upload() {                                      
        if (this.title != "" && this.title != undefined        // If filled in required input.
          && this.description != "" && this.description != undefined) {
            console.log("All needed fields filled in, uploading....");
            const form = new FormData();
            form.append('title', this.title);
            form.append('description', this.description);
            form.append('thumbnail', this.thumbnail);
            var oReq = new XMLHttpRequest();
            const _this = this;
            oReq.onload = function (res) {
              console.log (res.target.responseText);
              var result = JSON.parse(res.target.responseText);
              if (result.status == "ok") {     // Everything ok.
                _this.responseStatus = "Resultat OK";
                _this.responseMessage = "Spilleliste lagt til";
              }
              else {                                           // Something went wrong
                _this.responseStatus = "Resultat feilet";
                _this.responseMessage = "Feilmelding: " + result.errorMessage;
              }
              _this.$.resultDialog.open();
            }.bind(this);
            oReq.addEventListener("progress", this.updateProgress);
            oReq.addEventListener("load", this.transferComplete);
            oReq.addEventListener("error", this.transferFailed);
            oReq.addEventListener("abort", this.transferCanceled);

            oReq.open("POST", this.uploadURL);
            oReq.withCredentials = true;
            oReq.send(form);
        }
        else {                      // If not written something in some fields, give error.
          console.log("Please input in all required fields..")
          this.responseStatus = "Feilet"
          this.responseMessage = "Du må fylle inn alle felt først."
          this.$.resultDialog.open();
        }
      }

      /**
       * Set a thumbnail of the frame the player stands on.
       * 
       * This code is based on: https://bitbucket.org/okolloen/imt2291-v2018/src/30012325241c1c3826a3d6e596a459937a3a12d1/javascript_lab1/video.html?at=master&fileviewer=file-view-default
       */
       setThumbnail() {
        console.log("Starting setThumbnail")
        window.URL.revokeObjectURL(this.video_url);
        var cv = this.$.cv;
        const ctx = cv.getContext('2d');
        var player = this.$.player;
        cv.height = player.videoHeight/2;                                       // Set height
        cv.width = player.videoWidth/2;                                         // and width of canvas to height and width of video

        ctx.drawImage(player, 0, 0, player.videoWidth/2, player.videoHeight/2);                                          // Draw the currently showing image from the video player on the canvas
        this.thumbnail = cv.toDataURL();                                      // Get contents of canvas as png image (default)
        //const form = new FormData();
        console.log("PNG: " + this.thumbnail);
        // Can use XMLHttpRequest to send this data to the server
        // Base64 decode everything after first ","
      }


      updateProgress (oEvent) {
        if (oEvent.lengthComputable) {
          var percentComplete = oEvent.loaded / oEvent.total * 100;
          console.log("Percent complete: " + percentComplete);
        } else {
          // Unable to compute progress information since the total size is unknown
          console.log("Could not calculate percent complete")
        }
      }

      transferComplete(evt) {
        console.log("The transfer is complete.");
      }

      transferFailed(evt) {
        console.log("An error occurred while transferring the file.");
      }

      transferCanceled(evt) {
        console.log("The transfer has been canceled by the user.");
      }
    }

    window.customElements.define(PlaylistNewplaylist.is, PlaylistNewplaylist);
  </script>
</dom-module>
